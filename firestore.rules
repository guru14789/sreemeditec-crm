
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper: Check for specific roles from custom claims
    function hasRole(role) {
      return isSignedIn() && request.auth.token.role == role;
    }
    
    function isAdmin() {
      return hasRole('admin') || hasRole('system_admin');
    }

    // Products: Everyone can read, only admins can write
    match /products/{productId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Users collection: Admins only for writing roles
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if hasRole('system_admin');
    }

    // Attendance: Users can write their own record, but only once (via ID)
    match /attendance/{recordId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow create: if isSignedIn() && recordId.startsWith(request.auth.uid) && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid && !('checkOut' in resource.data));
    }

    // Points: No client-side direct writes allowed to total points
    // (Must go through a logic that validates events)
    match /pointHistory/{pointId} {
      allow read: if isSignedIn();
      allow create: if isAdmin(); // Only admins/system can trigger points via UI
    }

    // Invoices/Procurement: Signed in users can create/read
    match /invoices/{invoiceId} {
      allow read, create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
  }
}
